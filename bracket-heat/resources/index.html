<!DOCTYPE html> 
<head>
    <title>_BANNER_</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: relative;
        }
        #GroundControl {
            position: absolute;
            z-index: 500;
            left: 300px;
            top: 10px;
            width: 355px;
            height: 40px;
            background-color: #eee;
            border: 1px solid black;
            border-radius: 4px;
            padding: 4px;
        }

        #searchBox {
            left: 80%;
            top: 10px;
            width: 300px;
            z-index: 500;
            position: absolute;
        }
    </style>
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=_GMAPKEY_&libraries=&v=weekly"></script>

    <div id="map"></div>

    <div id="GroundControl">
        <span id="netName" style="font-weight: bold; font-size: 8pt;"></span>
        <button id="btnNone">None</button>
        <button id="btnHeight">Height</button>
        <button id="btnLoS">L-o-S</button>
        <button id="btnSignal">Signal</button>
        <br />
        <span style="font-weight: bold; font-size: 8pt;">CPE Height (m):</span> <input type="range" min="1" max="20" value="2" class="slider" id="cpeHeight" />
        <span id="cpeHeightDisplay">2</span>
        <select id="freq">
            <option value="60">60 Ghz</option>
            <option value="5.8">5.8 Ghz</option>
            <option value="3.6" selected="true">3.6 Ghz</option>
            <option value="2.4">2.4 Ghz</option>
        </select>
    </div>

    <div id="searchBox">
        Search: <input type="text" id="searcher" style="width: 250px"></input>
    </div>

    <script>
        const IspName = _ISP_NAME_;
        const CenterLat = _CENTER_LAT_;
        const CenterLon = _CENTER_LON_;
        const MapZoomDefault = _MAP_ZOOM_;
        const map_center = {lat: CenterLat, lng: CenterLon};
        let towerList = [];
        let map = null;
        let currentOverlay = null;
        let currentMarker = null;
        let addressMarker = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: MapZoomDefault,
                center: map_center
            });
            map.setTilt(0);
            $("#netName").text(IspName);
            loadTowers();
            bindHeight();
            $("#cpeHeight").change(function() {
                let h = $("#cpeHeight").val();
                $("#cpeHeightDisplay").text(h);
            });
            map.addListener("click", (mapsMouseEvent) => {
                let pos = mapsMouseEvent.latLng;
                // Add a marker
                if (currentMarker != null) {
                    currentMarker.setMap(null);
                    currentMarker = null;
                }
                currentMarker = new google.maps.Marker({
                    position: { lat: pos.lat(), lng: pos.lng() },
                    map: map,
                    icon: 'pngegg.png',
                    title: "Current Location"
                });
                // Draw lines to towers
                for (var i=0; i<towerList.length; i++) {
                    let t = towerList[i];
                    if (t.cpeLine != null) {
                        t.cpeLine.setMap(null);
                        t.cpeLine = null;
                    }
                    if (t.lineWindow != null) {
                        t.lineWindow.setMap(null);
                        t.lineWindow = null;
                    }
                }

                let h = $("#cpeHeight").val();
                let frequency = $("#freq").children("option:selected").val();
                $.get("/mapclick/" + pos.lat() + "/" + pos.lng() + "/" + h + "/" + frequency, (data) => {
                    for (var j=0; j<data.length; j++) {
                        let link = data[j];
                        let tower = towerList[link.i];
                        let path = [ { lat: pos.lat(), lng: pos.lng() }, { lat: link.lat, lng: link.lon } ];
                        tower.cpeLine = new google.maps.Polyline({
                            path: path,
                            geodesic: true,
                            strokeColor: color_ramp(link.rssi),
                            strokeOpacity: 1.0,
                            strokeWeight: 4,
                        });
                        tower.cpeLine.setMap(map);
                        google.maps.event.addListener(tower.cpeLine, 'mouseover', (e) => {
                            tower.lineWindow = new google.maps.InfoWindow();
                            tower.lineWindow.setPosition(e.latLng);
                            tower.lineWindow.setContent("<strong>Path to " + tower.name + "</strong><br /><strong>Estimated RSSI:</strong> " + link.rssi.toFixed(1) + "<br /><strong>Distance:</strong> " + link.distance_km.toFixed(1) + " km");
                            tower.lineWindow.open(map);
                        });
                        google.maps.event.addListener(tower.cpeLine, 'mouseout', (e) => {
                            tower.lineWindow.setMap(null);
                            tower.lineWindow = null;
                        });
                    }
                });
            });

            $("#searcher").change(function(data) {
                if (addressMarker != null) {
                    addressMarker.setMap(null);
                }

                var term = $("#searcher").val();
                term = encodeURIComponent(term);
                var url = "https://maps.googleapis.com/maps/api/geocode/json?address=" + term + "&key=_GMAPKEY_";
                $.get(url, function(gc) {
                    //console.log(gc);
                    if (gc.results.length > 0) {
                        var loc = gc.results[0].geometry.location;
                        addressMarker = new google.maps.Marker({
                            position: { lat: loc.lat, lng: loc.lng },
                            map: map,
                            title: $("#searcher").val()
                        });
                        map.panTo({ lat: loc.lat, lng: loc.lng });
                        map.setZoom(17);
                    }
                });
            });
        }

        function loadTowers() {
            $.get("/towers", (data) => {
                for (var i=0; i<data.length; i++) {
                    data[i].marker = new google.maps.Marker({
                        position: { lat: data[i].lat, lng: data[i].lon },
                        map: map,
                        icon: 'tower_Marker.png',
                        title: data[i].name
                    });
                    data[i].cpeLine = null;
                    data[i].lineWindow = null;
                }
                towerList = data;
            });
        }

        function removeCurrentOverlay() {
            if (currentOverlay != null) {
                currentOverlay.setMap(null);
                currentOverlay = null;
            }
        }

        function bindHeight() {
            $("#btnNone").click(function() {
                removeCurrentOverlay();
            });
            $("#btnHeight").click(function() {
                removeCurrentOverlay();
                let bounds = map.getBounds();
                currentOverlay = new HeightOverlay(bounds);
                currentOverlay.setMap(map);
            });
            $("#btnLoS").click(function() {
                removeCurrentOverlay();
                let bounds = map.getBounds();
                currentOverlay = new LosOverlay(bounds);
                currentOverlay.setMap(map);
            });
            $("#btnSignal").click(function() {
                removeCurrentOverlay();
                let bounds = map.getBounds();
                currentOverlay = new SignalOverlay(bounds);
                currentOverlay.setMap(map);
            });
        }

        class DynamicImageOverlay extends google.maps.OverlayView {
            constructor(bounds) {
                super();
            }

            onAdd() {
                this.div = document.createElement("div");
                this.div.style.borderStyle = "none";
                this.div.style.borderWidth = "0px";
                this.div.style.position = "absolute";
                // Create the img element and attach it to the div.
                const img = document.createElement("img");
                img.src = this.image;
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.position = "absolute";
                this.div.appendChild(img);
                // Add the element to the "overlayLayer" pane.
                const panes = this.getPanes();
                panes.overlayLayer.appendChild(this.div);
            }

            draw() {
                // We use the south-west and north-east
                // coordinates of the overlay to peg it to the correct position and size.
                // To do this, we need to retrieve the projection from the overlay.
                const overlayProjection = this.getProjection();
                // Retrieve the south-west and north-east coordinates of this overlay
                // in LatLngs and convert them to pixel coordinates.
                // We'll use these coordinates to resize the div.
                const sw = overlayProjection.fromLatLngToDivPixel(
                    this.bounds.getSouthWest()
                );
                const ne = overlayProjection.fromLatLngToDivPixel(
                    this.bounds.getNorthEast()
                );

                // Resize the image's div to fit the indicated dimensions.
                if (this.div) {
                    this.div.style.left = sw.x + "px";
                    this.div.style.top = ne.y + "px";
                    this.div.style.width = ne.x - sw.x + "px";
                    this.div.style.height = sw.y - ne.y + "px";
                }
            }

            onRemove() {
                if (this.div) {
                    this.div.parentNode.removeChild(this.div);
                    delete this.div;
                }
            }
        }

        class HeightOverlay extends DynamicImageOverlay {
            constructor(bounds) {
                super();
                this.bounds = bounds;
                let sw = bounds.getSouthWest();
                let ne = bounds.getNorthEast();
                let url = "heightmap/" + sw.lat() + "/" + sw.lng() + "/" + ne.lat() + "/" + ne.lng();
                this.image = url;
            }
        }

        class LosOverlay extends DynamicImageOverlay {
            constructor(bounds) {
                super();
                this.bounds = bounds;
                let sw = bounds.getSouthWest();
                let ne = bounds.getNorthEast();
                let h = $("#cpeHeight").val();
                let url = "losmap/" + sw.lat() + "/" + sw.lng() + "/" + ne.lat() + "/" + ne.lng() + "/" + h;
                this.image = url;
            }
        }

        class SignalOverlay extends DynamicImageOverlay {
            constructor(bounds) {
                super();
                this.bounds = bounds;
                let sw = bounds.getSouthWest();
                let ne = bounds.getNorthEast();
                let h = $("#cpeHeight").val();
                let frequency = $("#freq").children("option:selected").val();
                let url = "signalmap/" + sw.lat() + "/" + sw.lng() + "/" + ne.lat() + "/" + ne.lng() + "/" + h + "/" + frequency;
                this.image = url;
            }
        }

        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2)
                ; 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        function color_ramp(rssi) {
            rssi = Math.abs(rssi);
            if (rssi < 65.0) {
                return "#00FF00";
            } else if (rssi < 75.0) {
                return "#FFFF00";
            }
            return "#FF0000";
        }

        $(document).ready(initMap);
    </script>
</body>