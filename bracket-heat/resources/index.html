<!DOCTYPE html> 
<head>
    <title>_BANNER_</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: relative;
        }
        #GroundControl {
            position: absolute;
            z-index: 500;
            left: 300px;
            top: 10px;
            width: 355px;
            height: 20px;
            background-color: #eee;
            border: 1px solid black;
            border-radius: 4px;
            padding: 4px;
        }
    </style>
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=_GMAPKEY_&libraries=&v=weekly"></script>

    <div id="map"></div>

    <div id="GroundControl">
        <span id="netName" style="font-weight: bold; font-size: 8pt;"></span>
        <button id="btnNone">None</button>
        <button id="btnHeight">Height</button>
        <button id="btnLoS">L-o-S</button>
    </div>

    <script>
        const IspName = _ISP_NAME_;
        const CenterLat = _CENTER_LAT_;
        const CenterLon = _CENTER_LON_;
        const MapZoomDefault = _MAP_ZOOM_;
        const map_center = {lat: CenterLat, lng: CenterLon};
        let towerList = [];
        let map = null;
        let currentOverlay = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: MapZoomDefault,
                center: map_center
            });
            map.setTilt(0);
            $("#netName").text(IspName);
            loadTowers();
            bindHeight();
        }

        function loadTowers() {
            $.get("/towers", function(data) {
                for (var i=0; i<data.length; i++) {
                    data[i].marker = new google.maps.Marker({
                        position: { lat: data[i].lat, lng: data[i].lon },
                        map: map,
                        icon: 'tower_Marker.png',
                        title: data[i].name
                    });
                }
                towerList = data;
            });
        }

        function removeCurrentOverlay() {
            if (currentOverlay != null) {
                currentOverlay.setMap(null);
                currentOverlay = null;
            }
        }

        function bindHeight() {
            $("#btnNone").click(function() {
                removeCurrentOverlay();
            });
            $("#btnHeight").click(function() {
                removeCurrentOverlay();
                let bounds = map.getBounds();
                currentOverlay = new HeightOverlay(bounds);
                currentOverlay.setMap(map);
            });
            $("#btnLoS").click(function() {
                removeCurrentOverlay();
                let bounds = map.getBounds();
                currentOverlay = new LosOverlay(bounds);
                currentOverlay.setMap(map);
            });
        }

        class DynamicImageOverlay extends google.maps.OverlayView {
            constructor(bounds) {
                super();
            }

            onAdd() {
                this.div = document.createElement("div");
                this.div.style.borderStyle = "none";
                this.div.style.borderWidth = "0px";
                this.div.style.position = "absolute";
                // Create the img element and attach it to the div.
                const img = document.createElement("img");
                img.src = this.image;
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.position = "absolute";
                this.div.appendChild(img);
                // Add the element to the "overlayLayer" pane.
                const panes = this.getPanes();
                panes.overlayLayer.appendChild(this.div);
            }

            draw() {
                // We use the south-west and north-east
                // coordinates of the overlay to peg it to the correct position and size.
                // To do this, we need to retrieve the projection from the overlay.
                const overlayProjection = this.getProjection();
                // Retrieve the south-west and north-east coordinates of this overlay
                // in LatLngs and convert them to pixel coordinates.
                // We'll use these coordinates to resize the div.
                const sw = overlayProjection.fromLatLngToDivPixel(
                    this.bounds.getSouthWest()
                );
                const ne = overlayProjection.fromLatLngToDivPixel(
                    this.bounds.getNorthEast()
                );

                // Resize the image's div to fit the indicated dimensions.
                if (this.div) {
                    this.div.style.left = sw.x + "px";
                    this.div.style.top = ne.y + "px";
                    this.div.style.width = ne.x - sw.x + "px";
                    this.div.style.height = sw.y - ne.y + "px";
                }
            }

            onRemove() {
                if (this.div) {
                    this.div.parentNode.removeChild(this.div);
                    delete this.div;
                }
            }
        }

        class HeightOverlay extends DynamicImageOverlay {
            constructor(bounds) {
                super();
                this.bounds = bounds;
                let sw = bounds.getSouthWest();
                let ne = bounds.getNorthEast();
                let url = "heightmap/" + sw.lat() + "/" + sw.lng() + "/" + ne.lat() + "/" + ne.lng();
                this.image = url;
            }
        }

        class LosOverlay extends DynamicImageOverlay {
            constructor(bounds) {
                super();
                this.bounds = bounds;
                let sw = bounds.getSouthWest();
                let ne = bounds.getNorthEast();
                let url = "losmap/" + sw.lat() + "/" + sw.lng() + "/" + ne.lat() + "/" + ne.lng() + "/2.0";
                // TODO: 2.0 needs to replaced with a height slider
                this.image = url;
            }
        }

        $(document).ready(initMap);
    </script>
</body>